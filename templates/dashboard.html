{% extends "base.html" %}

{% block title %}Yönetici Paneli - NilüferAKS{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h4 class="text-light">
            <i class="bi bi-speedometer2 me-2"></i>Yönetici Paneli
        </h4>
    </div>
</div>

<!-- KPI Kartları -->
<div class="row g-4 mb-4">
    <!-- Yıllık Tasarruf -->
    <div class="col-md-3">
        <div class="card kpi-card h-100">
            <div class="card-body text-center">
                <div class="kpi-value" id="kpi-tasarruf">₺0</div>
                <div class="kpi-label">Yıllık Tasarruf</div>
                <small class="text-success" id="kpi-tasarruf-artis">
                    <i class="bi bi-arrow-up"></i> +%0
                </small>
            </div>
        </div>
    </div>
    
    <!-- CO2 Azalma -->
    <div class="col-md-3">
        <div class="card kpi-card h-100">
            <div class="card-body text-center">
                <div class="kpi-value" id="kpi-co2">130 ton</div>
                <div class="kpi-label">CO2 Azalma</div>
                <small class="text-success">
                    <i class="bi bi-tree"></i> 650 ağaç
                </small>
            </div>
        </div>
    </div>
    
    <!-- Mesafe Azalma -->
    <div class="col-md-3">
        <div class="card kpi-card h-100">
            <div class="card-body text-center">
                <div class="kpi-value" id="kpi-mesafe">%22</div>
                <div class="kpi-label">Mesafe Azalma</div>
                <small class="text-info">
                    <i class="bi bi-signpost"></i> -510 km/gün
                </small>
            </div>
        </div>
    </div>
    
    <!-- Günlük Tasarruf -->
    <div class="col-md-3">
        <div class="card kpi-card h-100">
            <div class="card-body text-center">
                <div class="kpi-value" id="kpi-sure">2.5 saat</div>
                <div class="kpi-label">Günlük Tasarruf</div>
                <small class="text-warning">
                    <i class="bi bi-clock"></i> /araç
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Sol Kolon: Harita -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="d-flex align-items-center">
                    <span><i class="bi bi-map me-2"></i>Araç Rota Görüntüleme</span>
                    <div class="ms-3 d-none d-md-flex" id="legend">
                        <span class="legend-item"><span class="legend-dot" style="background:#28a745;"></span>Başlangıç</span>
                        <span class="legend-item"><span class="legend-dot" style="background:#dc3545;"></span>Bitiş</span>
                        <span class="legend-item"><span class="legend-dot" style="background:#17a2b8;"></span>Duraklar</span>
                        <span class="legend-item"><span class="legend-line" style="background:#dc3545;"></span>Rota</span>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <select class="form-select form-select-sm" id="arac-select" style="width: 130px;">
                        <option value="">Araç Seç...</option>
                    </select>
                    <select class="form-select form-select-sm" id="tarih-select" style="width: 130px;">
                        <option value="">Tarih Seç...</option>
                    </select>
                    <button class="btn btn-sm btn-success" id="btn-rota-goster" disabled>
                        <i class="bi bi-eye me-1"></i>Göster
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="map"></div>
                <!-- Rota Bilgi Paneli -->
                <div id="rota-info" class="mt-3" style="display: none;">
                    <div class="row text-center g-2">
                        <div class="col-3">
                            <div class="bg-dark rounded p-2">
                                <div class="text-info fs-5 fw-bold" id="rota-durak">-</div>
                                <small class="text-muted">Durak</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="bg-dark rounded p-2">
                                <div class="text-warning fs-5 fw-bold" id="rota-mesafe">-</div>
                                <small class="text-muted">Mesafe (km)</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="bg-dark rounded p-2">
                                <div class="text-success fs-5 fw-bold" id="rota-arac-tipi">-</div>
                                <small class="text-muted">Araç Tipi</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="bg-dark rounded p-2">
                                <div class="text-danger fs-5 fw-bold" id="rota-tarih">-</div>
                                <small class="text-muted">Tarih</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sağ Kolon: Filo Durumu -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-truck me-2"></i>Filo Durumu
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Araç Tipi</th>
                            <th class="text-center">Adet</th>
                        </tr>
                    </thead>
                    <tbody id="fleet-table">
                        <tr>
                            <td><span class="badge badge-vincli">Vinçli</span></td>
                            <td class="text-center" id="fleet-vincli">-</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-buyuk">Büyük</span></td>
                            <td class="text-center" id="fleet-buyuk">-</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-kucuk">Küçük</span></td>
                            <td class="text-center" id="fleet-kucuk">-</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-secondary">
                            <td><strong>Toplam</strong></td>
                            <td class="text-center"><strong id="fleet-toplam">-</strong></td>
                        </tr>
                    </tfoot>
                </table>
                
                <hr>
                
                <!-- Mahalle Yoğunluk -->
                <h6 class="text-muted mb-3">Mahalle Bilgisi</h6>
                <div id="mahalle-yogunluk">
                    <p class="text-muted small"><i class="bi bi-hourglass-split me-1"></i>Veri yükleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Günlük Özet -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up me-2"></i>Günlük Performans
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3 class="text-info" id="stat-toplanan">-</h3>
                        <small class="text-muted">Toplanan (ton)</small>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-success" id="stat-mahalle">-</h3>
                        <small class="text-muted">Toplam Mahalle</small>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-warning" id="stat-konteyner">-</h3>
                        <small class="text-muted">Toplam Konteyner</small>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-primary" id="stat-gunluk-tonaj">-</h3>
                        <small class="text-muted">Günlük Ort. Tonaj</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Harita başlat - Nilüfer merkez
    const map = L.map('map').setView([40.22, 28.89], 12);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);
    
    // Rota layer group
    let rotaLayer = L.layerGroup().addTo(map);
    let markerLayer = L.layerGroup().addTo(map);
    
    // Nilüfer ilçe sınırını yükle
    async function loadNiluferSinir() {
        try {
            const response = await fetch('/api/nilufer/sinir');
            const data = await response.json();
            
            L.polygon(data.polygon, {
                color: '#1a1a1a',
                weight: 2,
                fillColor: '#333333',
                fillOpacity: 0.08,
                dashArray: '5,5'
            }).addTo(map);
            
        } catch (error) {
            console.error('Nilüfer sınırı yüklenemedi:', error);
        }
    }
    
    // Araç listesini yükle
    async function loadAracListesi() {
        try {
            const response = await fetch('/api/araclar');
            const data = await response.json();
            
            const select = document.getElementById('arac-select');
            data.araclar.forEach(arac => {
                const option = document.createElement('option');
                option.value = arac;
                option.textContent = `Araç ${arac}`;
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('Araç listesi yüklenemedi:', error);
        }
    }
    
    // Araç seçildiğinde tarihleri yükle
    document.getElementById('arac-select').addEventListener('change', async function() {
        const aracId = this.value;
        const tarihSelect = document.getElementById('tarih-select');
        const btnGoster = document.getElementById('btn-rota-goster');
        
        // Temizle
        tarihSelect.innerHTML = '<option value="">Tarih Seç...</option>';
        btnGoster.disabled = true;
        
        if (!aracId) return;
        
        try {
            const response = await fetch(`/api/arac/${aracId}/tarihler`);
            const data = await response.json();
            
            data.tarihler.forEach(tarih => {
                const option = document.createElement('option');
                option.value = tarih;
                option.textContent = tarih;
                tarihSelect.appendChild(option);
            });
            
        } catch (error) {
            console.error('Tarihler yüklenemedi:', error);
        }
    });
    
    // Tarih seçildiğinde butonu aktifleştir
    document.getElementById('tarih-select').addEventListener('change', function() {
        const aracId = document.getElementById('arac-select').value;
        const tarih = this.value;
        document.getElementById('btn-rota-goster').disabled = !(aracId && tarih);
    });
    
    // Rotayı göster butonu
    document.getElementById('btn-rota-goster').addEventListener('click', async function() {
        const aracId = document.getElementById('arac-select').value;
        const tarih = document.getElementById('tarih-select').value;
        
        if (!aracId || !tarih) return;
        
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Yükleniyor...';
        
        try {
            const response = await fetch(`/api/arac/${aracId}/rota?tarih=${tarih}`);
            const data = await response.json();
            
            if (data.hata) {
                alert(data.hata);
                return;
            }
            
            // Önceki rotayı temizle
            rotaLayer.clearLayers();
            markerLayer.clearLayers();
            
            // Koordinatları çıkar
            const coords = data.duraklar.map(d => [d.lat, d.lon]);
            
            // Rota çizgisi (kırmızı - mevcut rota)
            const polyline = L.polyline(coords, {
                color: '#dc3545',
                weight: 4,
                opacity: 0.8
            }).addTo(rotaLayer);
            
            // Başlangıç noktası (yeşil)
            const startMarker = L.circleMarker(coords[0], {
                radius: 12,
                fillColor: '#28a745',
                color: '#fff',
                weight: 3,
                fillOpacity: 1
            }).bindPopup(`<strong>BAŞLANGIÇ</strong><br>Saat: ${data.duraklar[0].saat}`).addTo(markerLayer);
            
            // Bitiş noktası (kırmızı)
            const endMarker = L.circleMarker(coords[coords.length - 1], {
                radius: 12,
                fillColor: '#dc3545',
                color: '#fff',
                weight: 3,
                fillOpacity: 1
            }).bindPopup(`<strong>BİTİŞ</strong><br>Saat: ${data.duraklar[data.duraklar.length - 1].saat}`).addTo(markerLayer);
            
            // Ara duraklar (küçük mavi noktalar)
            data.duraklar.slice(1, -1).forEach((durak, idx) => {
                L.circleMarker([durak.lat, durak.lon], {
                    radius: 5,
                    fillColor: '#17a2b8',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.8
                }).bindPopup(`<strong>Durak ${idx + 2}</strong><br>Saat: ${durak.saat}`).addTo(markerLayer);
            });
            
            // Haritayı rotaya odakla
            map.fitBounds(polyline.getBounds(), { padding: [30, 30] });
            
            // Bilgi panelini güncelle
            document.getElementById('rota-info').style.display = 'block';
            document.getElementById('rota-durak').textContent = data.durak_sayisi;
            document.getElementById('rota-mesafe').textContent = data.toplam_mesafe_km;
            document.getElementById('rota-arac-tipi').textContent = data.arac_tipi.split(' ')[0];
            document.getElementById('rota-tarih').textContent = data.tarih;
            
        } catch (error) {
            console.error('Rota yüklenemedi:', error);
            alert('Rota yüklenirken hata oluştu');
        } finally {
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-eye me-1"></i>Göster';
        }
    });
    
    // API'den verileri çek
    async function loadDashboard() {
        try {
            const response = await fetch('/api/dashboard');
            const data = await response.json();
            
            // KPI'ları güncelle - GERÇEK VERİLER, BİNLİK AYRAÇLI
            // Yıllık tasarruf: 19.300.000 formatı
            const tasarrufFormatted = new Intl.NumberFormat('tr-TR').format(data.yillik_tasarruf);
            document.getElementById('kpi-tasarruf').textContent = '₺' + tasarrufFormatted;
            document.getElementById('kpi-tasarruf-artis').innerHTML = `<i class="bi bi-arrow-up"></i> +%${data.yillik_tasarruf_artis}`;
            
            document.getElementById('kpi-co2').textContent = data.co2_azalma + ' ton';
            document.getElementById('kpi-mesafe').textContent = '%' + data.mesafe_azalma;
            document.getElementById('kpi-sure').textContent = data.gunluk_sure_tasarruf + ' saat';
            
            // Filo bilgilerini güncelle
            if (data.filo) {
                document.getElementById('fleet-vincli').textContent = data.filo.vincli;
                document.getElementById('fleet-buyuk').textContent = data.filo.buyuk;
                document.getElementById('fleet-kucuk').textContent = data.filo.kucuk;
                document.getElementById('fleet-toplam').textContent = data.toplam_arac;
            }
            
            // İstatistikleri güncelle
            document.getElementById('stat-mahalle').textContent = data.toplam_mahalle;
            document.getElementById('stat-konteyner').textContent = data.toplam_konteyner ? data.toplam_konteyner.toLocaleString('tr-TR') : '-';
            document.getElementById('stat-gunluk-tonaj').textContent = data.gunluk_tonaj ? data.gunluk_tonaj + ' ton' : '-';
            document.getElementById('stat-toplanan').textContent = data.yillik_tonaj ? data.yillik_tonaj.toLocaleString('tr-TR') : '-';
            
            // Mahalle bilgisi güncelle
            document.getElementById('mahalle-yogunluk').innerHTML = `
                <div class="d-flex justify-content-between mb-2">
                    <span>Toplam Mahalle:</span>
                    <strong class="text-success">${data.toplam_mahalle}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Toplam Konteyner:</span>
                    <strong class="text-info">${data.toplam_konteyner.toLocaleString('tr-TR')}</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Yıllık Tonaj:</span>
                    <strong class="text-warning">${data.yillik_tonaj.toLocaleString('tr-TR')} ton</strong>
                </div>
            `;
            
        } catch (error) {
            console.error('Dashboard yüklenemedi:', error);
        }
    }
    
    // Sayfa yüklendiğinde
    loadDashboard();
    loadNiluferSinir();
    loadAracListesi();
</script>
{% endblock %}